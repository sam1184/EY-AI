AWSTemplateFormatVersion: '2010-09-09'
Description: 'SecureBank Day 2 Lab 2: Multi-VPC Connectivity with VPC Peering'

Parameters:
  EnvironmentName:
    Description: Environment name prefix for resources
    Type: String
    Default: SecureBank-Day2-Lab2

Resources:
  # Production VPC
  ProductionVPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.0.0.0/16
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-Production-VPC'
        - Key: Environment
          Value: Production

  # Development VPC
  DevelopmentVPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.1.0.0/16
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-Development-VPC'
        - Key: Environment
          Value: Development

  # Staging VPC
  StagingVPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.2.0.0/16
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-Staging-VPC'
        - Key: Environment
          Value: Staging

  # Production VPC Subnets
  ProductionPrivateSubnet:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref ProductionVPC
      AvailabilityZone: !Select [0, !GetAZs '']
      CidrBlock: 10.0.1.0/24
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-Production-Private-Subnet'

  # Development VPC Subnets
  DevelopmentPrivateSubnet:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref DevelopmentVPC
      AvailabilityZone: !Select [0, !GetAZs '']
      CidrBlock: 10.1.1.0/24
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-Development-Private-Subnet'

  # Staging VPC Subnets
  StagingPrivateSubnet:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref StagingVPC
      AvailabilityZone: !Select [0, !GetAZs '']
      CidrBlock: 10.2.1.0/24
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-Staging-Private-Subnet'

  # VPC Peering Connections
  ProductionToStagingPeering:
    Type: AWS::EC2::VPCPeeringConnection
    Properties:
      VpcId: !Ref ProductionVPC
      PeerVpcId: !Ref StagingVPC
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-Production-to-Staging-Peering'

  StagingToDevelopmentPeering:
    Type: AWS::EC2::VPCPeeringConnection
    Properties:
      VpcId: !Ref StagingVPC
      PeerVpcId: !Ref DevelopmentVPC
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-Staging-to-Development-Peering'

  # Route Tables
  ProductionRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref ProductionVPC
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-Production-RouteTable'

  DevelopmentRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref DevelopmentVPC
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-Development-RouteTable'

  StagingRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref StagingVPC
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-Staging-RouteTable'

  # Routes for VPC Peering
  ProductionToStagingRoute:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref ProductionRouteTable
      DestinationCidrBlock: 10.2.0.0/16
      VpcPeeringConnectionId: !Ref ProductionToStagingPeering

  StagingToProductionRoute:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref StagingRouteTable
      DestinationCidrBlock: 10.0.0.0/16
      VpcPeeringConnectionId: !Ref ProductionToStagingPeering

  StagingToDevelopmentRoute:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref StagingRouteTable
      DestinationCidrBlock: 10.1.0.0/16
      VpcPeeringConnectionId: !Ref StagingToDevelopmentPeering

  DevelopmentToStagingRoute:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref DevelopmentRouteTable
      DestinationCidrBlock: 10.2.0.0/16
      VpcPeeringConnectionId: !Ref StagingToDevelopmentPeering

  # Subnet Route Table Associations
  ProductionSubnetRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref ProductionPrivateSubnet
      RouteTableId: !Ref ProductionRouteTable

  DevelopmentSubnetRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref DevelopmentPrivateSubnet
      RouteTableId: !Ref DevelopmentRouteTable

  StagingSubnetRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref StagingPrivateSubnet
      RouteTableId: !Ref StagingRouteTable

  # Security Groups for cross-VPC communication
  ProductionSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for Production VPC
      VpcId: !Ref ProductionVPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 10.2.0.0/16  # Allow HTTPS from Staging
          Description: HTTPS from Staging VPC
        - IpProtocol: icmp
          FromPort: -1
          ToPort: -1
          CidrIp: 10.2.0.0/16  # Allow ping from Staging
          Description: ICMP from Staging VPC
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-Production-SecurityGroup'

  StagingSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for Staging VPC
      VpcId: !Ref StagingVPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 10.0.0.0/16  # Allow HTTPS from Production
          Description: HTTPS from Production VPC
        - IpProtocol: tcp
          FromPort: 8080
          ToPort: 8080
          CidrIp: 10.1.0.0/16  # Allow app traffic from Development
          Description: Application traffic from Development VPC
        - IpProtocol: icmp
          FromPort: -1
          ToPort: -1
          CidrIp: 10.0.0.0/16  # Allow ping from Production
          Description: ICMP from Production VPC
        - IpProtocol: icmp
          FromPort: -1
          ToPort: -1
          CidrIp: 10.1.0.0/16  # Allow ping from Development
          Description: ICMP from Development VPC
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-Staging-SecurityGroup'

  DevelopmentSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for Development VPC
      VpcId: !Ref DevelopmentVPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 8080
          ToPort: 8080
          CidrIp: 10.2.0.0/16  # Allow app traffic from Staging
          Description: Application traffic from Staging VPC
        - IpProtocol: icmp
          FromPort: -1
          ToPort: -1
          CidrIp: 10.2.0.0/16  # Allow ping from Staging
          Description: ICMP from Staging VPC
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-Development-SecurityGroup'

  # Test EC2 instances for connectivity testing
  ProductionTestInstance:
    Type: AWS::EC2::Instance
    Properties:
      ImageId: ami-0c02fb55956c7d316  # Amazon Linux 2 AMI (update as needed)
      InstanceType: t3.micro
      SubnetId: !Ref ProductionPrivateSubnet
      SecurityGroupIds:
        - !Ref ProductionSecurityGroup
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          yum update -y
          yum install -y httpd
          systemctl start httpd
          systemctl enable httpd
          echo "<h1>SecureBank Production Server</h1>" > /var/www/html/index.html
          echo "<p>VPC: ${ProductionVPC}</p>" >> /var/www/html/index.html
          echo "<p>Instance ID: $(curl -s http://169.254.169.254/latest/meta-data/instance-id)</p>" >> /var/www/html/index.html
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-Production-Test-Instance'
        - Key: Environment
          Value: Production

  StagingTestInstance:
    Type: AWS::EC2::Instance
    Properties:
      ImageId: ami-0c02fb55956c7d316  # Amazon Linux 2 AMI (update as needed)
      InstanceType: t3.micro
      SubnetId: !Ref StagingPrivateSubnet
      SecurityGroupIds:
        - !Ref StagingSecurityGroup
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          yum update -y
          yum install -y httpd
          systemctl start httpd
          systemctl enable httpd
          echo "<h1>SecureBank Staging Server</h1>" > /var/www/html/index.html
          echo "<p>VPC: ${StagingVPC}</p>" >> /var/www/html/index.html
          echo "<p>Instance ID: $(curl -s http://169.254.169.254/latest/meta-data/instance-id)</p>" >> /var/www/html/index.html
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-Staging-Test-Instance'
        - Key: Environment
          Value: Staging

  DevelopmentTestInstance:
    Type: AWS::EC2::Instance
    Properties:
      ImageId: ami-0c02fb55956c7d316  # Amazon Linux 2 AMI (update as needed)
      InstanceType: t3.micro
      SubnetId: !Ref DevelopmentPrivateSubnet
      SecurityGroupIds:
        - !Ref DevelopmentSecurityGroup
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          yum update -y
          yum install -y httpd nodejs npm
          systemctl start httpd
          systemctl enable httpd
          echo "<h1>SecureBank Development Server</h1>" > /var/www/html/index.html
          echo "<p>VPC: ${DevelopmentVPC}</p>" >> /var/www/html/index.html
          echo "<p>Instance ID: $(curl -s http://169.254.169.254/latest/meta-data/instance-id)</p>" >> /var/www/html/index.html
          # Start a simple Node.js server on port 8080
          cat > /home/ec2-user/server.js << 'EOF'
          const http = require('http');
          const server = http.createServer((req, res) => {
            res.writeHead(200, {'Content-Type': 'text/html'});
            res.end('<h1>SecureBank Development API</h1><p>Port 8080 - Development Environment</p>');
          });
          server.listen(8080, () => {
            console.log('Development server running on port 8080');
          });
          EOF
          node /home/ec2-user/server.js &
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-Development-Test-Instance'
        - Key: Environment
          Value: Development

Outputs:
  ProductionVPC:
    Description: Production VPC ID
    Value: !Ref ProductionVPC
    Export:
      Name: !Sub '${EnvironmentName}-Production-VPC'

  StagingVPC:
    Description: Staging VPC ID
    Value: !Ref StagingVPC
    Export:
      Name: !Sub '${EnvironmentName}-Staging-VPC'

  DevelopmentVPC:
    Description: Development VPC ID
    Value: !Ref DevelopmentVPC
    Export:
      Name: !Sub '${EnvironmentName}-Development-VPC'

  ProductionToStagingPeering:
    Description: Production to Staging VPC Peering Connection
    Value: !Ref ProductionToStagingPeering

  StagingToDevelopmentPeering:
    Description: Staging to Development VPC Peering Connection
    Value: !Ref StagingToDevelopmentPeering

  ProductionTestInstanceIP:
    Description: Production test instance private IP
    Value: !GetAtt ProductionTestInstance.PrivateIp

  StagingTestInstanceIP:
    Description: Staging test instance private IP
    Value: !GetAtt StagingTestInstance.PrivateIp

  DevelopmentTestInstanceIP:
    Description: Development test instance private IP
    Value: !GetAtt DevelopmentTestInstance.PrivateIp

  ConnectivityTestCommands:
    Description: Commands to test VPC connectivity
    Value: !Sub |
      # SSH to instances and test connectivity:
      # From Staging instance, ping Production:
      ping ${ProductionTestInstance.PrivateIp}
      # From Staging instance, ping Development:
      ping ${DevelopmentTestInstance.PrivateIp}
      # Test HTTP connectivity:
      curl http://${DevelopmentTestInstance.PrivateIp}:8080