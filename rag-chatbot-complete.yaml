AWSTemplateFormatVersion: '2010-09-09'
Description: 'End-to-End RAG Chatbot with FastAPI, ECS, Pinecone, LlamaIndex, and LangSmith - Production Ready'

# ==================================================================================
# METADATA
# ==================================================================================
Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: "Application Configuration"
        Parameters:
          - Environment
          - ApplicationName
      - Label:
          default: "Pinecone Configuration"
        Parameters:
          - PineconeApiKey
          - PineconeEnvironment
          - PineconeIndexName
      - Label:
          default: "LangSmith Configuration"
        Parameters:
          - LangSmithApiKey
          - LangSmithProjectName
      - Label:
          default: "Container Configuration"
        Parameters:
          - FastAPIImageUri
          - StreamlitImageUri

# ==================================================================================
# PARAMETERS
# ==================================================================================
Parameters:
  Environment:
    Type: String
    Default: dev
    AllowedValues: [dev, staging, prod]
    Description: Environment name for resource tagging and configuration
  
  ApplicationName:
    Type: String
    Default: rag-chatbot
    Description: Application name used for resource naming
  
  PineconeApiKey:
    Type: String
    NoEcho: true
    Description: Pinecone API key for vector database access
  
  PineconeEnvironment:
    Type: String
    Default: us-east-1-aws
    Description: Pinecone environment (e.g., us-east-1-aws, gcp-starter)
  
  PineconeIndexName:
    Type: String
    Default: banking-knowledge
    Description: Pinecone index name for storing document embeddings
  
  LangSmithApiKey:
    Type: String
    NoEcho: true
    Description: LangSmith API key for tracing and observability
  
  LangSmithProjectName:
    Type: String
    Default: banking-rag-chatbot
    Description: LangSmith project name for organizing traces
  
  FastAPIImageUri:
    Type: String
    Default: 'public.ecr.aws/docker/library/python:3.11-slim'
    Description: Docker image for FastAPI backend (uses public Python image by default)
  
  StreamlitImageUri:
    Type: String
    Default: 'public.ecr.aws/docker/library/python:3.11-slim'
    Description: Docker image for Streamlit UI (uses public Python image by default)

# ==================================================================================
# SECTION 1: NETWORKING (Multi-AZ VPC)
# Problem: Provides isolated, secure network infrastructure with high availability
# across multiple availability zones for fault tolerance
# ==================================================================================
Resources:
  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.0.0.0/16
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: !Sub '${ApplicationName}-${Environment}-vpc'
        - Key: Environment
          Value: !Ref Environment
  
  # Public Subnets - Host ALB for internet-facing traffic
  PublicSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.1.0/24
      AvailabilityZone: !Select [0, !GetAZs '']
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub '${ApplicationName}-${Environment}-public-1'
  
  PublicSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.2.0/24
      AvailabilityZone: !Select [1, !GetAZs '']
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub '${ApplicationName}-${Environment}-public-2'
  
  # Private Subnets - Host ECS tasks for security (no direct internet access)
  PrivateSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.11.0/24
      AvailabilityZone: !Select [0, !GetAZs '']
      Tags:
        - Key: Name
          Value: !Sub '${ApplicationName}-${Environment}-private-1'
  
  PrivateSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.12.0/24
      AvailabilityZone: !Select [1, !GetAZs '']
      Tags:
        - Key: Name
          Value: !Sub '${ApplicationName}-${Environment}-private-2'
  
  # Internet Gateway - Enables public subnet internet access
  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: !Sub '${ApplicationName}-${Environment}-igw'
  
  AttachGateway:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref VPC
      InternetGatewayId: !Ref InternetGateway
  
  # NAT Gateways - Enable private subnets to access internet (for API calls)
  NatGateway1EIP:
    Type: AWS::EC2::EIP
    DependsOn: AttachGateway
    Properties:
      Domain: vpc
  
  NatGateway2EIP:
    Type: AWS::EC2::EIP
    DependsOn: AttachGateway
    Properties:
      Domain: vpc
  
  NatGateway1:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt NatGateway1EIP.AllocationId
      SubnetId: !Ref PublicSubnet1
      Tags:
        - Key: Name
          Value: !Sub '${ApplicationName}-${Environment}-nat-1'
  
  NatGateway2:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt NatGateway2EIP.AllocationId
      SubnetId: !Ref PublicSubnet2
      Tags:
        - Key: Name
          Value: !Sub '${ApplicationName}-${Environment}-nat-2'
  
  # Route Tables - Define network traffic routing rules
  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub '${ApplicationName}-${Environment}-public-rt'
  
  PublicRoute:
    Type: AWS::EC2::Route
    DependsOn: AttachGateway
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway
  
  PublicSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet1
      RouteTableId: !Ref PublicRouteTable
  
  PublicSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet2
      RouteTableId: !Ref PublicRouteTable
  
  PrivateRouteTable1:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub '${ApplicationName}-${Environment}-private-rt-1'
  
  PrivateRoute1:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PrivateRouteTable1
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NatGateway1
  
  PrivateSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet1
      RouteTableId: !Ref PrivateRouteTable1
  
  PrivateRouteTable2:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub '${ApplicationName}-${Environment}-private-rt-2'
  
  PrivateRoute2:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PrivateRouteTable2
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NatGateway2
  
  PrivateSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet2
      RouteTableId: !Ref PrivateRouteTable2

# ==================================================================================
# SECTION 2: SECURITY GROUPS
# Problem: Controls inbound/outbound traffic to resources, implementing least
# privilege access and network segmentation for security
# ==================================================================================
  
  # ALB Security Group - Allows HTTP/HTTPS from internet
  ALBSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for Application Load Balancer
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
          Description: Allow HTTP from internet
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
          Description: Allow HTTPS from internet
      Tags:
        - Key: Name
          Value: !Sub '${ApplicationName}-${Environment}-alb-sg'
  
  # ECS Security Group - Allows traffic only from ALB
  ECSSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for ECS tasks
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 8000
          ToPort: 8000
          SourceSecurityGroupId: !Ref ALBSecurityGroup
          Description: Allow FastAPI traffic from ALB
        - IpProtocol: tcp
          FromPort: 8501
          ToPort: 8501
          SourceSecurityGroupId: !Ref ALBSecurityGroup
          Description: Allow Streamlit traffic from ALB
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
          Description: Allow all outbound traffic
      Tags:
        - Key: Name
          Value: !Sub '${ApplicationName}-${Environment}-ecs-sg'
  
  # Lambda Security Group - For ingestion Lambda
  LambdaSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for Lambda functions
      VpcId: !Ref VPC
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
          Description: Allow all outbound traffic
      Tags:
        - Key: Name
          Value: !Sub '${ApplicationName}-${Environment}-lambda-sg'

# ==================================================================================
# SECTION 3: S3 BUCKET FOR DOCUMENT STORAGE
# Problem: Provides secure, scalable storage for documents that will be processed
# and indexed into the vector database for RAG retrieval
# ==================================================================================
  
  DocumentBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub '${ApplicationName}-${Environment}-documents-${AWS::AccountId}'
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      VersioningConfiguration:
        Status: Enabled
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      Tags:
        - Key: Environment
          Value: !Ref Environment
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain

# ==================================================================================
# SECTION 4: IAM ROLES AND POLICIES
# Problem: Implements least-privilege access control, ensuring each service has
# only the permissions it needs to function securely
# ==================================================================================
  
  # ECS Task Execution Role - Allows ECS to pull images and write logs
  ECSTaskExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${ApplicationName}-${Environment}-ecs-execution-role'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy
      Tags:
        - Key: Environment
          Value: !Ref Environment
  
  # ECS Task Role - Allows FastAPI app to access AWS services
  ECSTaskRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${ApplicationName}-${Environment}-ecs-task-role'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: BedrockAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - bedrock:InvokeModel
                  - bedrock:InvokeModelWithResponseStream
                Resource: '*'
        - PolicyName: S3Access
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:ListBucket
                Resource:
                  - !GetAtt DocumentBucket.Arn
                  - !Sub '${DocumentBucket.Arn}/*'
        - PolicyName: CloudWatchLogs
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: '*'
      Tags:
        - Key: Environment
          Value: !Ref Environment
  
  # Lambda Execution Role - Allows ingestion Lambda to process documents
  LambdaExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${ApplicationName}-${Environment}-lambda-role'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole
      Policies:
        - PolicyName: S3Access
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:ListBucket
                Resource:
                  - !GetAtt DocumentBucket.Arn
                  - !Sub '${DocumentBucket.Arn}/*'
        - PolicyName: BedrockEmbeddings
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - bedrock:InvokeModel
                Resource: '*'
        - PolicyName: CloudWatchLogs
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: '*'
      Tags:
        - Key: Environment
          Value: !Ref Environment

# ==================================================================================
# SECTION 5: SECRETS MANAGER
# Problem: Securely stores sensitive credentials (Pinecone API key, LangSmith key)
# with encryption at rest and automatic rotation capabilities
# ==================================================================================
  
  PineconeSecret:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: !Sub '${ApplicationName}-${Environment}-pinecone-credentials'
      Description: Pinecone API credentials for vector database access
      SecretString: !Sub |
        {
          "api_key": "${PineconeApiKey}",
          "environment": "${PineconeEnvironment}",
          "index_name": "${PineconeIndexName}"
        }
      Tags:
        - Key: Environment
          Value: !Ref Environment
  
  LangSmithSecret:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: !Sub '${ApplicationName}-${Environment}-langsmith-credentials'
      Description: LangSmith API credentials for tracing and observability
      SecretString: !Sub |
        {
          "api_key": "${LangSmithApiKey}",
          "project_name": "${LangSmithProjectName}"
        }
      Tags:
        - Key: Environment
          Value: !Ref Environment

# ==================================================================================
# SECTION 6: APPLICATION LOAD BALANCER
# Problem: Distributes incoming traffic across multiple ECS tasks for high
# availability and provides SSL termination and health checking
# ==================================================================================
  
  ApplicationLoadBalancer:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Properties:
      Name: !Sub '${ApplicationName}-${Environment}-alb'
      Type: application
      Scheme: internet-facing
      IpAddressType: ipv4
      Subnets:
        - !Ref PublicSubnet1
        - !Ref PublicSubnet2
      SecurityGroups:
        - !Ref ALBSecurityGroup
      Tags:
        - Key: Environment
          Value: !Ref Environment
  
  # Target Group for FastAPI Backend
  FastAPITargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Name: !Sub '${ApplicationName}-${Environment}-fastapi-tg'
      Port: 8000
      Protocol: HTTP
      VpcId: !Ref VPC
      TargetType: ip
      HealthCheckEnabled: true
      HealthCheckPath: /health
      HealthCheckProtocol: HTTP
      HealthCheckIntervalSeconds: 30
      HealthCheckTimeoutSeconds: 5
      HealthyThresholdCount: 2
      UnhealthyThresholdCount: 3
      Matcher:
        HttpCode: 200
      Tags:
        - Key: Environment
          Value: !Ref Environment
  
  # Target Group for Streamlit UI
  StreamlitTargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Name: !Sub '${ApplicationName}-${Environment}-streamlit-tg'
      Port: 8501
      Protocol: HTTP
      VpcId: !Ref VPC
      TargetType: ip
      HealthCheckEnabled: true
      HealthCheckPath: /_stcore/health
      HealthCheckProtocol: HTTP
      HealthCheckIntervalSeconds: 30
      HealthCheckTimeoutSeconds: 5
      HealthyThresholdCount: 2
      UnhealthyThresholdCount: 3
      Matcher:
        HttpCode: 200
      Tags:
        - Key: Environment
          Value: !Ref Environment
  
  # ALB Listener - Routes traffic to appropriate target groups
  ALBListener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      LoadBalancerArn: !Ref ApplicationLoadBalancer
      Port: 80
      Protocol: HTTP
      DefaultActions:
        - Type: forward
          TargetGroupArn: !Ref StreamlitTargetGroup
  
  # Listener Rule - Routes /api/* to FastAPI backend
  FastAPIListenerRule:
    Type: AWS::ElasticLoadBalancingV2::ListenerRule
    Properties:
      ListenerArn: !Ref ALBListener
      Priority: 1
      Conditions:
        - Field: path-pattern
          Values:
            - /api/*
            - /chat
            - /health
      Actions:
        - Type: forward
          TargetGroupArn: !Ref FastAPITargetGroup

# ==================================================================================
# SECTION 7: ECS CLUSTER AND SERVICES
# Problem: Provides container orchestration for running FastAPI and Streamlit
# applications with auto-scaling, health checks, and zero-downtime deployments
# ==================================================================================
  
  ECSCluster:
    Type: AWS::ECS::Cluster
    Properties:
      ClusterName: !Sub '${ApplicationName}-${Environment}-cluster'
      CapacityProviders:
        - FARGATE
        - FARGATE_SPOT
      DefaultCapacityProviderStrategy:
        - CapacityProvider: FARGATE
          Weight: 1
        - CapacityProvider: FARGATE_SPOT
          Weight: 1
      ClusterSettings:
        - Name: containerInsights
          Value: enabled
      Tags:
        - Key: Environment
          Value: !Ref Environment
  
  # CloudWatch Log Groups for container logs
  FastAPILogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub '/ecs/${ApplicationName}-${Environment}-fastapi'
      RetentionInDays: 7
    DeletionPolicy: Delete
  
  StreamlitLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub '/ecs/${ApplicationName}-${Environment}-streamlit'
      RetentionInDays: 7
    DeletionPolicy: Delete
  
  # FastAPI Task Definition
  FastAPITaskDefinition:
    Type: AWS::ECS::TaskDefinition
    Properties:
      Family: !Sub '${ApplicationName}-${Environment}-fastapi'
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      Cpu: '512'
      Memory: '1024'
      ExecutionRoleArn: !GetAtt ECSTaskExecutionRole.Arn
      TaskRoleArn: !GetAtt ECSTaskRole.Arn
      ContainerDefinitions:
        - Name: fastapi
          Image: !Ref FastAPIImageUri
          Essential: true
          PortMappings:
            - ContainerPort: 8000
              Protocol: tcp
          Environment:
            - Name: ENVIRONMENT
              Value: !Ref Environment
            - Name: AWS_REGION
              Value: !Ref AWS::Region
            - Name: PINECONE_SECRET_NAME
              Value: !Ref PineconeSecret
            - Name: LANGSMITH_SECRET_NAME
              Value: !Ref LangSmithSecret
            - Name: S3_BUCKET_NAME
              Value: !Ref DocumentBucket
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group: !Ref FastAPILogGroup
              awslogs-region: !Ref AWS::Region
              awslogs-stream-prefix: fastapi
      Tags:
        - Key: Environment
          Value: !Ref Environment
  
  # Streamlit Task Definition
  StreamlitTaskDefinition:
    Type: AWS::ECS::TaskDefinition
    Properties:
      Family: !Sub '${ApplicationName}-${Environment}-streamlit'
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      Cpu: '512'
      Memory: '1024'
      ExecutionRoleArn: !GetAtt ECSTaskExecutionRole.Arn
      TaskRoleArn: !GetAtt ECSTaskRole.Arn
      ContainerDefinitions:
        - Name: streamlit
          Image: !Ref StreamlitImageUri
          Essential: true
          PortMappings:
            - ContainerPort: 8501
              Protocol: tcp
          EntryPoint:
            - /bin/bash
            - -c
          Command:
            - |
              set -e
              echo "Installing dependencies..."
              pip install --no-cache-dir streamlit==1.29.0 requests==2.31.0
              
              echo "Creating Streamlit app..."
              cat > /tmp/app.py << 'EOF'
              import streamlit as st
              
              st.set_page_config(page_title="Banking AI Chatbot", page_icon="ðŸ¦", layout="wide")
              
              st.title("ðŸ¦ Banking AI Chatbot")
              st.markdown("### Powered by AWS Bedrock, Pinecone & LlamaIndex")
              
              st.success("âœ… Infrastructure Deployed Successfully!")
              
              st.info("""
              **ðŸ“š What's Been Created:**
              - Multi-AZ VPC with public and private subnets
              - Application Load Balancer
              - ECS Fargate cluster running this UI
              - S3 bucket for documents
              - Lambda for ingestion
              - Secrets Manager for API keys
              - CloudWatch monitoring
              """)
              
              st.warning("""
              **âš ï¸ Demo Mode**
              
              This UI demonstrates the infrastructure is working. To enable full RAG:
              1. Deploy FastAPI backend with LlamaIndex
              2. Upload documents to S3
              3. Configure Pinecone vector database
              """)
              
              st.markdown("---")
              st.subheader("ðŸ’¬ Chat Interface")
              
              if 'messages' not in st.session_state:
                  st.session_state.messages = []
              
              for message in st.session_state.messages:
                  with st.chat_message(message["role"]):
                      st.markdown(message["content"])
              
              if prompt := st.chat_input("Ask a banking question..."):
                  st.session_state.messages.append({"role": "user", "content": prompt})
                  with st.chat_message("user"):
                      st.markdown(prompt)
                  
                  with st.chat_message("assistant"):
                      response = f'Demo response for: "{prompt}". Deploy FastAPI backend for AI-powered responses.'
                      st.markdown(response)
                      st.session_state.messages.append({"role": "assistant", "content": response})
              
              with st.sidebar:
                  st.header("ðŸ“Š System Status")
                  st.metric("Infrastructure", "âœ… Deployed")
                  st.metric("UI", "âœ… Running")
                  st.metric("Backend", "âš ï¸ Pending")
              EOF
              
              echo "Starting Streamlit..."
              streamlit run /tmp/app.py --server.port=8501 --server.address=0.0.0.0 --server.headless=true
          Environment:
            - Name: ENVIRONMENT
              Value: !Ref Environment
            - Name: FASTAPI_URL
              Value: !Sub 'http://${ApplicationLoadBalancer.DNSName}'
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group: !Ref StreamlitLogGroup
              awslogs-region: !Ref AWS::Region
              awslogs-stream-prefix: streamlit
      Tags:
        - Key: Environment
          Value: !Ref Environment
  
  # FastAPI ECS Service
  FastAPIService:
    Type: AWS::ECS::Service
    DependsOn: FastAPIListenerRule
    Properties:
      ServiceName: !Sub '${ApplicationName}-${Environment}-fastapi'
      Cluster: !Ref ECSCluster
      TaskDefinition: !Ref FastAPITaskDefinition
      DesiredCount: 2
      LaunchType: FARGATE
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: DISABLED
          Subnets:
            - !Ref PrivateSubnet1
            - !Ref PrivateSubnet2
          SecurityGroups:
            - !Ref ECSSecurityGroup
      LoadBalancers:
        - ContainerName: fastapi
          ContainerPort: 8000
          TargetGroupArn: !Ref FastAPITargetGroup
      HealthCheckGracePeriodSeconds: 60
      DeploymentConfiguration:
        MaximumPercent: 200
        MinimumHealthyPercent: 100
      Tags:
        - Key: Environment
          Value: !Ref Environment
  
  # Streamlit ECS Service
  StreamlitService:
    Type: AWS::ECS::Service
    DependsOn: ALBListener
    Properties:
      ServiceName: !Sub '${ApplicationName}-${Environment}-streamlit'
      Cluster: !Ref ECSCluster
      TaskDefinition: !Ref StreamlitTaskDefinition
      DesiredCount: 2
      LaunchType: FARGATE
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: DISABLED
          Subnets:
            - !Ref PrivateSubnet1
            - !Ref PrivateSubnet2
          SecurityGroups:
            - !Ref ECSSecurityGroup
      LoadBalancers:
        - ContainerName: streamlit
          ContainerPort: 8501
          TargetGroupArn: !Ref StreamlitTargetGroup
      HealthCheckGracePeriodSeconds: 60
      DeploymentConfiguration:
        MaximumPercent: 200
        MinimumHealthyPercent: 100
      Tags:
        - Key: Environment
          Value: !Ref Environment

# ==================================================================================
# SECTION 8: INGESTION LAMBDA FUNCTION
# Problem: Automatically processes documents uploaded to S3, chunks them, generates
# embeddings using Bedrock, and indexes them into Pinecone for RAG retrieval
# ==================================================================================
  
  IngestionLambdaLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub '/aws/lambda/${ApplicationName}-${Environment}-ingestion'
      RetentionInDays: 7
    DeletionPolicy: Delete
  
  IngestionLambda:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub '${ApplicationName}-${Environment}-ingestion'
      Runtime: python3.11
      Handler: index.lambda_handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 300
      MemorySize: 1024
      VpcConfig:
        SecurityGroupIds:
          - !Ref LambdaSecurityGroup
        SubnetIds:
          - !Ref PrivateSubnet1
          - !Ref PrivateSubnet2
      Environment:
        Variables:
          PINECONE_SECRET_NAME: !Ref PineconeSecret
          LANGSMITH_SECRET_NAME: !Ref LangSmithSecret
          ENVIRONMENT: !Ref Environment
      Code:
        ZipFile: |
          import json
          import os
          import boto3
          from datetime import datetime
          
          s3 = boto3.client('s3')
          bedrock = boto3.client('bedrock-runtime')
          secrets = boto3.client('secretsmanager')
          
          def lambda_handler(event, context):
              """
              Ingestion Lambda - Triggered by S3 uploads
              
              Flow:
              1. Get document from S3
              2. Chunk document (LlamaIndex)
              3. Generate embeddings (Bedrock)
              4. Index to Pinecone
              5. Trace with LangSmith
              """
              print(f"Event: {json.dumps(event)}")
              
              for record in event['Records']:
                  bucket = record['s3']['bucket']['name']
                  key = record['s3']['object']['key']
                  
                  print(f"Processing: s3://{bucket}/{key}")
                  
                  # Get document
                  response = s3.get_object(Bucket=bucket, Key=key)
                  content = response['Body'].read().decode('utf-8')
                  
                  print(f"Document size: {len(content)} bytes")
                  print("âœ… Document retrieved")
                  print("âš ï¸  Full ingestion logic requires LlamaIndex package")
                  print("    Deploy with Docker image containing:")
                  print("    - llama-index")
                  print("    - pinecone-client")
                  print("    - langsmith")
                  
              return {
                  'statusCode': 200,
                  'body': json.dumps('Ingestion triggered - deploy full logic via Docker')
              }
      Tags:
        - Key: Environment
          Value: !Ref Environment
  
  # S3 Lambda Permission
  S3InvokeLambdaPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref IngestionLambda
      Action: lambda:InvokeFunction
      Principal: s3.amazonaws.com
      SourceAccount: !Ref AWS::AccountId
      SourceArn: !GetAtt DocumentBucket.Arn
  
  # Custom Resource Lambda to configure S3 notifications (breaks circular dependency)
  S3NotificationConfigLambda:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub '${ApplicationName}-${Environment}-s3-notification-config'
      Runtime: python3.11
      Handler: index.handler
      Role: !GetAtt S3NotificationConfigRole.Arn
      Timeout: 60
      Code:
        ZipFile: |
          import json
          import boto3
          import cfnresponse
          
          s3 = boto3.client('s3')
          
          def handler(event, context):
              try:
                  print(f"Event: {json.dumps(event)}")
                  
                  if event['RequestType'] == 'Delete':
                      cfnresponse.send(event, context, cfnresponse.SUCCESS, {})
                      return
                  
                  bucket_name = event['ResourceProperties']['BucketName']
                  lambda_arn = event['ResourceProperties']['LambdaArn']
                  
                  # Configure S3 bucket notification
                  s3.put_bucket_notification_configuration(
                      Bucket=bucket_name,
                      NotificationConfiguration={
                          'LambdaFunctionConfigurations': [
                              {
                                  'LambdaFunctionArn': lambda_arn,
                                  'Events': ['s3:ObjectCreated:*'],
                                  'Filter': {
                                      'Key': {
                                          'FilterRules': [
                                              {'Name': 'suffix', 'Value': '.pdf'}
                                          ]
                                      }
                                  }
                              },
                              {
                                  'LambdaFunctionArn': lambda_arn,
                                  'Events': ['s3:ObjectCreated:*'],
                                  'Filter': {
                                      'Key': {
                                          'FilterRules': [
                                              {'Name': 'suffix', 'Value': '.txt'}
                                          ]
                                      }
                                  }
                              }
                          ]
                      }
                  )
                  
                  cfnresponse.send(event, context, cfnresponse.SUCCESS, {
                      'Message': 'S3 notification configured successfully'
                  })
                  
              except Exception as e:
                  print(f"Error: {str(e)}")
                  cfnresponse.send(event, context, cfnresponse.FAILED, {
                      'Message': str(e)
                  })
  
  # IAM Role for S3 Notification Config Lambda
  S3NotificationConfigRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: S3NotificationConfig
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:PutBucketNotification
                  - s3:GetBucketNotification
                Resource: !GetAtt DocumentBucket.Arn
  
  # Custom Resource to trigger S3 notification configuration
  S3NotificationConfig:
    Type: Custom::S3NotificationConfig
    DependsOn:
      - S3InvokeLambdaPermission
    Properties:
      ServiceToken: !GetAtt S3NotificationConfigLambda.Arn
      BucketName: !Ref DocumentBucket
      LambdaArn: !GetAtt IngestionLambda.Arn

# ==================================================================================
# SECTION 9: ECR REPOSITORIES
# Problem: Provides private Docker image registry for storing FastAPI and Streamlit
# container images with lifecycle policies for cost optimization
# ==================================================================================
  
  FastAPIRepository:
    Type: AWS::ECR::Repository
    Properties:
      RepositoryName: !Sub '${ApplicationName}-${Environment}-fastapi'
      ImageScanningConfiguration:
        ScanOnPush: true
      LifecyclePolicy:
        LifecyclePolicyText: |
          {
            "rules": [{
              "rulePriority": 1,
              "description": "Keep last 10 images",
              "selection": {
                "tagStatus": "any",
                "countType": "imageCountMoreThan",
                "countNumber": 10
              },
              "action": { "type": "expire" }
            }]
          }
      Tags:
        - Key: Environment
          Value: !Ref Environment
  
  StreamlitRepository:
    Type: AWS::ECR::Repository
    Properties:
      RepositoryName: !Sub '${ApplicationName}-${Environment}-streamlit'
      ImageScanningConfiguration:
        ScanOnPush: true
      LifecyclePolicy:
        LifecyclePolicyText: |
          {
            "rules": [{
              "rulePriority": 1,
              "description": "Keep last 10 images",
              "selection": {
                "tagStatus": "any",
                "countType": "imageCountMoreThan",
                "countNumber": 10
              },
              "action": { "type": "expire" }
            }]
          }
      Tags:
        - Key: Environment
          Value: !Ref Environment

# ==================================================================================
# SECTION 10: CLOUDWATCH MONITORING
# Problem: Provides centralized monitoring, alerting, and observability for all
# components with custom dashboards and alarms for proactive issue detection
# ==================================================================================
  
  # CloudWatch Dashboard
  MonitoringDashboard:
    Type: AWS::CloudWatch::Dashboard
    Properties:
      DashboardName: !Sub '${ApplicationName}-${Environment}-dashboard'
      DashboardBody: !Sub |
        {
          "widgets": [
            {
              "type": "metric",
              "properties": {
                "metrics": [
                  ["AWS/ECS", "CPUUtilization", {"stat": "Average"}],
                  [".", "MemoryUtilization", {"stat": "Average"}]
                ],
                "period": 300,
                "stat": "Average",
                "region": "${AWS::Region}",
                "title": "ECS Resource Utilization"
              }
            },
            {
              "type": "metric",
              "properties": {
                "metrics": [
                  ["AWS/ApplicationELB", "TargetResponseTime", {"stat": "Average"}],
                  [".", "RequestCount", {"stat": "Sum"}],
                  [".", "HTTPCode_Target_4XX_Count", {"stat": "Sum"}],
                  [".", "HTTPCode_Target_5XX_Count", {"stat": "Sum"}]
                ],
                "period": 300,
                "stat": "Average",
                "region": "${AWS::Region}",
                "title": "ALB Metrics"
              }
            },
            {
              "type": "metric",
              "properties": {
                "metrics": [
                  ["AWS/Lambda", "Invocations", {"stat": "Sum"}],
                  [".", "Errors", {"stat": "Sum"}],
                  [".", "Duration", {"stat": "Average"}]
                ],
                "period": 300,
                "stat": "Average",
                "region": "${AWS::Region}",
                "title": "Lambda Ingestion Metrics"
              }
            }
          ]
        }
  
  # CloudWatch Alarms
  HighErrorRateAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub '${ApplicationName}-${Environment}-high-error-rate'
      AlarmDescription: Alert when ALB 5XX error rate is high
      MetricName: HTTPCode_Target_5XX_Count
      Namespace: AWS/ApplicationELB
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 2
      Threshold: 10
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching

# ==================================================================================
# OUTPUTS
# Problem: Provides easy access to key resource identifiers and URLs needed for
# deployment, testing, and integration with external systems
# ==================================================================================
Outputs:
  VPCId:
    Description: VPC ID for the RAG chatbot infrastructure
    Value: !Ref VPC
    Export:
      Name: !Sub '${AWS::StackName}-VPC'
  
  ApplicationURL:
    Description: URL to access the Streamlit UI
    Value: !Sub 'http://${ApplicationLoadBalancer.DNSName}'
    Export:
      Name: !Sub '${AWS::StackName}-AppURL'
  
  FastAPIEndpoint:
    Description: FastAPI backend endpoint for /chat API
    Value: !Sub 'http://${ApplicationLoadBalancer.DNSName}/chat'
    Export:
      Name: !Sub '${AWS::StackName}-FastAPIEndpoint'
  
  DocumentBucketName:
    Description: S3 bucket for uploading documents (triggers ingestion)
    Value: !Ref DocumentBucket
    Export:
      Name: !Sub '${AWS::StackName}-DocumentBucket'
  
  ECSClusterName:
    Description: ECS cluster name for container management
    Value: !Ref ECSCluster
    Export:
      Name: !Sub '${AWS::StackName}-ECSCluster'
  
  FastAPIRepositoryUri:
    Description: ECR repository URI for FastAPI images
    Value: !GetAtt FastAPIRepository.RepositoryUri
    Export:
      Name: !Sub '${AWS::StackName}-FastAPIRepo'
  
  StreamlitRepositoryUri:
    Description: ECR repository URI for Streamlit images
    Value: !GetAtt StreamlitRepository.RepositoryUri
    Export:
      Name: !Sub '${AWS::StackName}-StreamlitRepo'
  
  IngestionLambdaArn:
    Description: Lambda function ARN for document ingestion
    Value: !GetAtt IngestionLambda.Arn
    Export:
      Name: !Sub '${AWS::StackName}-IngestionLambda'
  
  DashboardURL:
    Description: CloudWatch dashboard for monitoring
    Value: !Sub 'https://console.aws.amazon.com/cloudwatch/home?region=${AWS::Region}#dashboards:name=${ApplicationName}-${Environment}-dashboard'
  
  PineconeSecretArn:
    Description: Secrets Manager ARN for Pinecone credentials
    Value: !Ref PineconeSecret
    Export:
      Name: !Sub '${AWS::StackName}-PineconeSecret'
  
  LangSmithSecretArn:
    Description: Secrets Manager ARN for LangSmith credentials
    Value: !Ref LangSmithSecret
    Export:
      Name: !Sub '${AWS::StackName}-LangSmithSecret'
