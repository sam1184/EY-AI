AWSTemplateFormatVersion: '2010-09-09'
Description: 'SecureBank Day 3 Lab 1: EC2 Operations and Instance Management'

Parameters:
  EnvironmentName:
    Description: Environment name prefix for resources
    Type: String
    Default: SecureBank-Day3-Lab1
  
  KeyPairName:
    Description: EC2 Key Pair for SSH access (must exist in your AWS account)
    Type: AWS::EC2::KeyPair::KeyName
    ConstraintDescription: Must be the name of an existing EC2 KeyPair

Resources:
  # VPC for the lab
  SecureBankVPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.4.0.0/16
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-VPC'

  # Internet Gateway
  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-IGW'

  InternetGatewayAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      InternetGatewayId: !Ref InternetGateway
      VpcId: !Ref SecureBankVPC

  # Public Subnet
  PublicSubnet:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref SecureBankVPC
      AvailabilityZone: !Select [0, !GetAZs '']
      CidrBlock: 10.4.1.0/24
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-Public-Subnet-AZ1'

  # Second Public Subnet for ALB (requires 2 AZs)
  PublicSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref SecureBankVPC
      AvailabilityZone: !Select [1, !GetAZs '']
      CidrBlock: 10.4.3.0/24
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-Public-Subnet-AZ2'

  # Private Subnet
  PrivateSubnet:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref SecureBankVPC
      AvailabilityZone: !Select [0, !GetAZs '']
      CidrBlock: 10.4.2.0/24
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-Private-Subnet'

  # NAT Gateway
  NatGatewayEIP:
    Type: AWS::EC2::EIP
    DependsOn: InternetGatewayAttachment
    Properties:
      Domain: vpc

  NatGateway:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt NatGatewayEIP.AllocationId
      SubnetId: !Ref PublicSubnet

  # Route Tables
  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref SecureBankVPC
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-Public-Routes'

  DefaultPublicRoute:
    Type: AWS::EC2::Route
    DependsOn: InternetGatewayAttachment
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway

  PublicSubnetRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PublicRouteTable
      SubnetId: !Ref PublicSubnet

  PublicSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PublicRouteTable
      SubnetId: !Ref PublicSubnet2

  PrivateRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref SecureBankVPC
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-Private-Routes'

  DefaultPrivateRoute:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PrivateRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NatGateway

  PrivateSubnetRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PrivateRouteTable
      SubnetId: !Ref PrivateSubnet

  # Security Groups
  WebServerSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for web servers
      VpcId: !Ref SecureBankVPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
          Description: HTTP from internet
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
          Description: HTTPS from internet
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: 0.0.0.0/0
          Description: SSH access
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-WebServer-SG'

  AppServerSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for application servers
      VpcId: !Ref SecureBankVPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 8080
          ToPort: 8080
          SourceSecurityGroupId: !Ref WebServerSecurityGroup
          Description: Application traffic from web servers
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: 10.4.0.0/16
          Description: SSH from VPC
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-AppServer-SG'

  # IAM Role for EC2 instances
  EC2Role:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/CloudWatchAgentServerPolicy
        - arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore
      Policies:
        - PolicyName: SecureBankEC2OperationsPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - ec2:DescribeInstances
                  - ec2:DescribeInstanceStatus
                  - ec2:DescribeVolumes
                  - ec2:DescribeSnapshots
                  - ec2:CreateSnapshot
                  - ec2:DescribeImages
                  - ec2:DescribeSecurityGroups
                  - ec2:DescribeNetworkInterfaces
                  - cloudwatch:PutMetricData
                  - cloudwatch:GetMetricStatistics
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                  - s3:GetObject
                  - s3:PutObject
                Resource: '*'

  EC2InstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Roles:
        - !Ref EC2Role

  # Launch Template for consistent instance configuration
  WebServerLaunchTemplate:
    Type: AWS::EC2::LaunchTemplate
    Properties:
      LaunchTemplateName: !Sub '${EnvironmentName}-WebServer-Template'
      LaunchTemplateData:
        ImageId: ami-0c02fb55956c7d316  # Amazon Linux 2 AMI
        InstanceType: t3.micro
        KeyName: !Ref KeyPairName
        IamInstanceProfile:
          Arn: !GetAtt EC2InstanceProfile.Arn
        SecurityGroupIds:
          - !Ref WebServerSecurityGroup
        UserData:
          Fn::Base64: !Sub |
            #!/bin/bash
            yum update -y
            yum install -y httpd htop iotop nethogs
            systemctl start httpd
            systemctl enable httpd
            
            # Install CloudWatch agent
            wget https://s3.amazonaws.com/amazoncloudwatch-agent/amazon_linux/amd64/latest/amazon-cloudwatch-agent.rpm
            rpm -U ./amazon-cloudwatch-agent.rpm
            
            # Create CloudWatch agent config
            cat > /opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json << 'EOF'
            {
              "metrics": {
                "namespace": "SecureBank/EC2",
                "metrics_collected": {
                  "cpu": {
                    "measurement": ["cpu_usage_idle", "cpu_usage_iowait", "cpu_usage_user", "cpu_usage_system"],
                    "metrics_collection_interval": 60
                  },
                  "disk": {
                    "measurement": ["used_percent"],
                    "metrics_collection_interval": 60,
                    "resources": ["*"]
                  },
                  "diskio": {
                    "measurement": ["io_time"],
                    "metrics_collection_interval": 60,
                    "resources": ["*"]
                  },
                  "mem": {
                    "measurement": ["mem_used_percent"],
                    "metrics_collection_interval": 60
                  },
                  "netstat": {
                    "measurement": ["tcp_established", "tcp_time_wait"],
                    "metrics_collection_interval": 60
                  },
                  "swap": {
                    "measurement": ["swap_used_percent"],
                    "metrics_collection_interval": 60
                  }
                }
              },
              "logs": {
                "logs_collected": {
                  "files": {
                    "collect_list": [
                      {
                        "file_path": "/var/log/httpd/access_log",
                        "log_group_name": "/aws/ec2/securebank/httpd/access",
                        "log_stream_name": "{instance_id}"
                      },
                      {
                        "file_path": "/var/log/httpd/error_log",
                        "log_group_name": "/aws/ec2/securebank/httpd/error",
                        "log_stream_name": "{instance_id}"
                      }
                    ]
                  }
                }
              }
            }
            EOF
            
            # Start CloudWatch agent
            /opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl \
              -a fetch-config -m ec2 -c file:/opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json -s
            
            # Create a banking web application
            cat > /var/www/html/index.html << 'EOF'
            <!DOCTYPE html>
            <html>
            <head>
                <title>SecureBank - Operations Dashboard</title>
                <style>
                    body { font-family: Arial, sans-serif; margin: 20px; background: #f0f8ff; }
                    .container { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
                    .header { color: #1e3a8a; border-bottom: 3px solid #3b82f6; padding-bottom: 15px; margin-bottom: 20px; }
                    .status-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin: 20px 0; }
                    .status-card { background: #f8fafc; padding: 20px; border-radius: 8px; border-left: 4px solid #10b981; }
                    .metric { background: #eff6ff; padding: 15px; border-radius: 6px; margin: 10px 0; }
                    .alert { background: #fef2f2; border: 1px solid #fecaca; padding: 15px; border-radius: 6px; margin: 15px 0; }
                </style>
                <script>
                    function updateMetrics() {
                        document.getElementById('timestamp').innerHTML = new Date().toLocaleString();
                        // Simulate real-time metrics
                        document.getElementById('cpu-usage').innerHTML = Math.floor(Math.random() * 30 + 10) + '%';
                        document.getElementById('memory-usage').innerHTML = Math.floor(Math.random() * 40 + 30) + '%';
                        document.getElementById('disk-usage').innerHTML = Math.floor(Math.random() * 20 + 15) + '%';
                        document.getElementById('network-io').innerHTML = Math.floor(Math.random() * 100 + 50) + ' MB/s';
                    }
                    setInterval(updateMetrics, 5000);
                    window.onload = updateMetrics;
                </script>
            </head>
            <body>
                <div class="container">
                    <h1 class="header">üè¶ SecureBank - EC2 Operations Dashboard</h1>
                    
                    <div class="status-grid">
                        <div class="status-card">
                            <h3>üñ•Ô∏è Instance Status</h3>
                            <p><strong>Status:</strong> Running</p>
                            <p><strong>Instance ID:</strong> <span id="instance-id">Loading...</span></p>
                            <p><strong>Instance Type:</strong> t3.micro</p>
                            <p><strong>Last Updated:</strong> <span id="timestamp"></span></p>
                        </div>
                        
                        <div class="status-card">
                            <h3>üìä Performance Metrics</h3>
                            <div class="metric">CPU Usage: <span id="cpu-usage">--</span></div>
                            <div class="metric">Memory Usage: <span id="memory-usage">--</span></div>
                            <div class="metric">Disk Usage: <span id="disk-usage">--</span></div>
                            <div class="metric">Network I/O: <span id="network-io">--</span></div>
                        </div>
                        
                        <div class="status-card">
                            <h3>üîß Operations Tools</h3>
                            <ul>
                                <li>CloudWatch Agent: Active</li>
                                <li>System Monitoring: Enabled</li>
                                <li>Log Aggregation: Configured</li>
                                <li>Auto Scaling: Ready</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="alert">
                        <h4>üö® Operations Lab Instructions</h4>
                        <p><strong>SSH Commands to try:</strong></p>
                        <ul>
                            <li><code>htop</code> - Interactive process viewer</li>
                            <li><code>iotop</code> - I/O monitoring</li>
                            <li><code>nethogs</code> - Network usage by process</li>
                            <li><code>df -h</code> - Disk space usage</li>
                            <li><code>free -m</code> - Memory usage</li>
                            <li><code>systemctl status httpd</code> - Service status</li>
                        </ul>
                    </div>
                </div>
                
                <script>
                    // Get instance metadata
                    fetch('http://169.254.169.254/latest/meta-data/instance-id')
                        .then(response => response.text())
                        .then(data => document.getElementById('instance-id').innerHTML = data)
                        .catch(error => document.getElementById('instance-id').innerHTML = 'Not available');
                </script>
            </body>
            </html>
            EOF
            
            # Create system monitoring scripts
            cat > /home/ec2-user/monitor-system.sh << 'EOF'
            #!/bin/bash
            echo "=== SecureBank System Monitoring ==="
            echo "Timestamp: $(date)"
            echo ""
            echo "=== CPU Usage ==="
            top -bn1 | grep "Cpu(s)" | awk '{print $2 $3 $4 $5 $6 $7 $8}'
            echo ""
            echo "=== Memory Usage ==="
            free -h
            echo ""
            echo "=== Disk Usage ==="
            df -h
            echo ""
            echo "=== Network Connections ==="
            netstat -tuln | head -10
            echo ""
            echo "=== Running Processes (Top 10) ==="
            ps aux --sort=-%cpu | head -11
            EOF
            
            chmod +x /home/ec2-user/monitor-system.sh
            chown ec2-user:ec2-user /home/ec2-user/monitor-system.sh
        TagSpecifications:
          - ResourceType: instance
            Tags:
              - Key: Name
                Value: !Sub '${EnvironmentName}-WebServer'
              - Key: Environment
                Value: !Ref EnvironmentName
              - Key: Tier
                Value: Web

  # Web Server Instances
  WebServer1:
    Type: AWS::EC2::Instance
    Properties:
      LaunchTemplate:
        LaunchTemplateId: !Ref WebServerLaunchTemplate
        Version: !GetAtt WebServerLaunchTemplate.LatestVersionNumber
      SubnetId: !Ref PublicSubnet
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-WebServer-1'
        - Key: ServerRole
          Value: Primary

  WebServer2:
    Type: AWS::EC2::Instance
    Properties:
      LaunchTemplate:
        LaunchTemplateId: !Ref WebServerLaunchTemplate
        Version: !GetAtt WebServerLaunchTemplate.LatestVersionNumber
      SubnetId: !Ref PublicSubnet
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-WebServer-2'
        - Key: ServerRole
          Value: Secondary

  # Application Server
  AppServer:
    Type: AWS::EC2::Instance
    Properties:
      ImageId: ami-0c02fb55956c7d316  # Amazon Linux 2 AMI
      InstanceType: t3.small
      KeyName: !Ref KeyPairName
      SubnetId: !Ref PrivateSubnet
      SecurityGroupIds:
        - !Ref AppServerSecurityGroup
      IamInstanceProfile: !Ref EC2InstanceProfile
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          yum update -y
          yum install -y java-11-openjdk nodejs npm python3 pip3 htop iotop
          
          # Create application server
          mkdir -p /opt/securebank-app
          cat > /opt/securebank-app/server.js << 'EOF'
          const http = require('http');
          const os = require('os');
          
          const server = http.createServer((req, res) => {
              const stats = {
                  timestamp: new Date().toISOString(),
                  hostname: os.hostname(),
                  uptime: os.uptime(),
                  loadavg: os.loadavg(),
                  memory: {
                      total: Math.round(os.totalmem() / 1024 / 1024),
                      free: Math.round(os.freemem() / 1024 / 1024),
                      used: Math.round((os.totalmem() - os.freemem()) / 1024 / 1024)
                  },
                  cpu: os.cpus().length
              };
              
              res.writeHead(200, {'Content-Type': 'application/json'});
              res.end(JSON.stringify(stats, null, 2));
          });
          
          server.listen(8080, () => {
              console.log('SecureBank App Server running on port 8080');
          });
          EOF
          
          cd /opt/securebank-app
          node server.js &
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-AppServer'
        - Key: Tier
          Value: Application

  # Application Load Balancer
  ApplicationLoadBalancer:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Properties:
      Name: !Sub '${EnvironmentName}-ALB'
      Scheme: internet-facing
      Type: application
      Subnets:
        - !Ref PublicSubnet
        - !Ref PublicSubnet2  # Second AZ for high availability
      SecurityGroups:
        - !Ref WebServerSecurityGroup
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-ALB'

  # Target Group
  WebServerTargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Name: !Sub '${EnvironmentName}-WebServers'
      Port: 80
      Protocol: HTTP
      VpcId: !Ref SecureBankVPC
      HealthCheckPath: /
      HealthCheckProtocol: HTTP
      HealthCheckIntervalSeconds: 30
      HealthyThresholdCount: 2
      UnhealthyThresholdCount: 3
      Targets:
        - Id: !Ref WebServer1
          Port: 80
        - Id: !Ref WebServer2
          Port: 80
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-WebServer-TG'

  # ALB Listener
  ALBListener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      DefaultActions:
        - Type: forward
          TargetGroupArn: !Ref WebServerTargetGroup
      LoadBalancerArn: !Ref ApplicationLoadBalancer
      Port: 80
      Protocol: HTTP

Outputs:
  VPCId:
    Description: VPC ID
    Value: !Ref SecureBankVPC

  LoadBalancerURL:
    Description: Application Load Balancer URL
    Value: !Sub 'http://${ApplicationLoadBalancer.DNSName}'

  WebServer1PublicIP:
    Description: Web Server 1 Public IP
    Value: !GetAtt WebServer1.PublicIp

  WebServer2PublicIP:
    Description: Web Server 2 Public IP
    Value: !GetAtt WebServer2.PublicIp

  AppServerPrivateIP:
    Description: Application Server Private IP
    Value: !GetAtt AppServer.PrivateIp

  OperationsCommands:
    Description: Commands for EC2 operations testing
    Value: !Sub |
      # SSH to web servers:
      ssh -i ${KeyPairName}.pem ec2-user@${WebServer1.PublicIp}
      ssh -i ${KeyPairName}.pem ec2-user@${WebServer2.PublicIp}
      
      # Run system monitoring:
      ./monitor-system.sh
      
      # Test load balancer:
      curl http://${ApplicationLoadBalancer.DNSName}
      
      # Monitor processes:
      htop
      iotop
      nethogs